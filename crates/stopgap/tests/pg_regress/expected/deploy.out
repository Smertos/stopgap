CREATE EXTENSION IF NOT EXISTS plts;
CREATE EXTENSION
CREATE EXTENSION IF NOT EXISTS stopgap;
CREATE EXTENSION
CREATE SCHEMA workspace;
CREATE SCHEMA
CREATE OR REPLACE FUNCTION workspace.echo(args jsonb)
RETURNS jsonb
LANGUAGE plts
AS $$
export default (ctx) => ctx.args;
$$;
CREATE FUNCTION
SELECT stopgap.deploy('prod', 'workspace', 'demo') > 0 AS deployed;
 deployed 
----------
 t
(1 row)

SELECT (stopgap.status('prod')->>'active_deployment_id')::bigint > 0 AS has_active;
 has_active 
------------
 t
(1 row)

SELECT jsonb_array_length(stopgap.deployments('prod')) = 1 AS one_deployment;
 one_deployment 
----------------
 t
(1 row)

SELECT (stopgap.deployments('prod')->0->>'is_active')::boolean AS first_is_active;
 first_is_active 
-----------------
 t
(1 row)

SELECT p.proname
FROM pg_proc p
JOIN pg_namespace n ON n.oid = p.pronamespace
WHERE n.nspname = 'live_deployment'
ORDER BY p.proname;
 proname 
---------
 echo
(1 row)

SELECT live_deployment.echo('{"ok":true}'::jsonb);
      echo      
----------------
 {"ok": true}
(1 row)
